name: publish

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'main'
      - name: Install dependencies
        run: |
          # Ensure ts-node and typescript are installed locally
          yarn add --dev ts-node typescript --ignore-scripts
      - name: Update release notes
        run: |
          # Create a temporary runner script using .ts extension
          echo "import { addCurrentChangelog } from './scripts/add-changelog.js'; await addCurrentChangelog(); console.log('Changelog update script executed.');" > temp-runner.ts

          # Execute the temporary script with npx ts-node
          # Set NODE_OPTIONS to ensure Node uses the ts-node ESM loader
          # Use --esm flag for ts-node as well
          NODE_OPTIONS="--loader ts-node/esm" npx ts-node --esm temp-runner.ts

          # Optional: Remove the temporary file afterwards
          rm temp-runner.ts
        working-directory: ./ # Make sure this is the root of your checkout
      - name: Checkout Docs
        uses: actions/checkout@v4
        with:
          repository: SAP/ai-sdk
          token: ${{ secrets.BOT_SDK_JS_FOR_DOCS_REPO_PR }}
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
          path: ./ai-sdk      
      - name: Open PR
        run: |
          cd ai-sdk
          git config --local user.email "cloudsdk@sap.com"
          git config --local user.name "SAP Cloud SDK Bot"
          git checkout -b "update-release-notes"
          git commit -m "update release notes" -a
          git push -u origin update-release-notes

          echo ${{ secrets.BOT_SDK_JS_FOR_DOCS_REPO_PR }} | gh auth login --hostname github.com --with-token
          gh config set prompt disabled
          PR_BODY="Auto-created by update release notes workflow."
          PR_TITLE="Update JS Release Notes"
          gh pr create --head "update-release-notes" --title "${PR_TITLE}" --body "${PR_BODY}"
      # - uses: sap/ai-sdk-js/.github/actions/setup@main
      # - name: publish
      #   run: |
      #     yarn changeset publish
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPMJS_ACCESS_TOKEN }}
