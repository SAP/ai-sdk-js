name: publish

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'main'
      - name: Checkout Docs
        uses: actions/checkout@v4
        with:
          repository: SAP/ai-sdk
          token: ${{ secrets.BOT_SDK_JS_FOR_DOCS_REPO_PR }}
          fetch-depth: 0 # otherwise, there would be errors pushing refs to the destination repository.
          path: ./ai-sdk
      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10 # Or specify your project's pnpm version
      # Install dependencies using pnpm
      - name: Install dependencies
        run: pnpm install

      # Update release notes using pnpm
      - name: Update release notes
        run: |
          echo $(pwd) # Confirm the directory
          # Execute using pnpm to ensure the local ts-node is used within the workspace context
          # NODE_OPTIONS tells Node how to load .ts files
          # pnpm ts-node runs the local version
          # --esm tells ts-node to use ESM mode
          NODE_OPTIONS="--loader ts-node/esm" pnpm ts-node --esm scripts/execute-add-changelog.ts
        working-directory: ./ # Make sure this is the root of your checkout

      - name: Open PR
        id: open_pr
        run: |
          cd ai-sdk
          git config --local user.email "cloudsdk@sap.com"
          git config --local user.name "SAP Cloud SDK Bot"
          BRANCH_NAME="update-release-notes"
          git checkout -b "${BRANCH_NAME}"
          git add docs-js/release-notes.mdx
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "update release notes" -a
            git push -u origin "${BRANCH_NAME}"

            echo ${{ secrets.BOT_SDK_JS_FOR_DOCS_REPO_PR }} | gh auth login --hostname github.com --with-token
            gh config set prompt disabled
            PR_BODY="Auto-created by update release notes workflow."
            PR_TITLE="Update JS Release Notes"
            gh pr create --head "${BRANCH_NAME}" --title "${PR_TITLE}" --body "${PR_BODY}"
          fi
          echo "RELEASE_NOTES_BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: 'Check Whether Release Notes PR Can Be Merged'
        uses: ./.github/actions/pr-is-mergeable
        with:
          pr-ref: ${{ steps.open_pr.outputs.RELEASE_NOTES_BRANCH_NAME }}
          repo: SAP/ai-sdk
          token: ${{ secrets.BOT_SDK_JS_FOR_DOCS_REPO_PR }}
          excluded-check-runs: |
            {
              \"Build Cloud SDK Documentation\": [\"dependabot\"]
            }
      # - uses: sap/ai-sdk-js/.github/actions/setup@main
      # - name: publish
      #   run: |
      #     pnpm changeset publish # Use pnpm here too if publishing
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPMJS_ACCESS_TOKEN }}
