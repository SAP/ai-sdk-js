name: 'Spec File Update Workflow (Cron Job)'

on:
  schedule:
    # At 03:21 on every 15th day-of-month from 1 through 31.
    # Example:
    #  2025-04-16 03:21:00
    #  2025-05-01 03:21:00
    #  2025-05-16 03:21:00
    - cron: 21 3 1/15 * *
  workflow_dispatch:

jobs:
  update-all-specs:
    runs-on: ubuntu-latest
    permissions:
      actions: write

    strategy:
      matrix:
        file:
          - ai-api
          - document-grounding
          - prompt-registry
          - orchestration
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v6

      - name: 'Get orchestration latest release'
        id: get-orch-version
        if: matrix.file == 'orchestration'
        run: |
          # Fetch the latest release from the orchestration repo using the API
          ORCH_VERSION=$(curl --silent --request GET \
            --url "https://github.tools.sap/api/v3/repos/AI/llm-orchestration/releases/latest" \
            -H "Authorization: Bearer $GH_TOOLS_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" | jq -r '.tag_name // "main"')
          
          if [ -z "$ORCH_VERSION" ] || [ "$ORCH_VERSION" = "null" ]; then
            echo "No release found, defaulting to main"
            ORCH_VERSION="main"
          fi
          
          echo "Orchestration version: $ORCH_VERSION"
          echo "version=$ORCH_VERSION" >> "$GITHUB_OUTPUT"
        env:
          GH_TOOLS_TOKEN: ${{ secrets.GH_TOOLS_TOKEN }}

      - name: 'Trigger spec update'
        run: |
          BRANCH="main"

          if [ "${{ matrix.file }}" = "orchestration" ]; then
            BRANCH="${{ steps.get-orch-version.outputs.version }}"
          fi

          echo "Triggering spec-update for ${{ matrix.file }} with ref $BRANCH"

          gh workflow run spec-update.yaml \
            --ref main \
            --field file=${{ matrix.file }} \
            --field file-ref=$BRANCH \
            --field create-pr=true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Slack Notification'
        if: failure()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            blocks:
              - type: 'section'
                text:
                  type: 'mrkdwn'
                  text: '‚ö†Ô∏è Weekly spec update failed! üò¨ Please inspect & fix by clicking <https://github.com/SAP/ai-sdk-js/actions/runs/${{ github.run_id }}|here>'
