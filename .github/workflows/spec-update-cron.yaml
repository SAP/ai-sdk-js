name: 'Spec File Update Workflow (Cron Job)'

on:
  schedule:
    # At 03:21 on every 15th day-of-month from 1 through 31.
    # Example:
    #  2025-04-16 03:21:00
    #  2025-05-01 03:21:00
    #  2025-05-16 03:21:00
    - cron: 21 3 1/15 * *
  workflow_dispatch:

jobs:
  update-all-specs:
    runs-on: ubuntu-latest
    permissions:
      actions: write

    strategy:
      matrix:
        file:
          - ai-api
          - document-grounding
          - prompt-registry
          - orchestration
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v6

      - name: 'Get orchestration version'
        if: matrix.file == 'orchestration'
        run: |
          ORCH_VERSION=$(curl --silent --request GET \
            --url "https://github.tools.sap/api/v3/repos/MLF-prod/mlf-gitops-prod/contents/services/llm-orchestration/source/Chart.yaml?ref=aws.eu-central-1.prod-eu/current" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github.v3.raw" | grep 'version:' | awk '{print $2}')

          if [ -z "$ORCH_VERSION" ]; then
              echo "Failed to fetch orchestration version"
              exit 1
          fi
          echo "Orchestration version: $ORCH_VERSION"
          echo "ORCH_VERSION=$ORCH_VERSION" >> "$GITHUB_ENV"
        env:
          TOKEN: ${{ secrets.GH_TOOLS_TOKEN }}

      - name: 'Trigger spec update'
        run: |
          BRANCH="main"
          if [ "${{ matrix.file }}" = "orchestration" ]; then
            # remove hotfix suffix 0.110.13-2 -> 0.110.13
            ORCH_VERSION=$(echo "$ORCH_VERSION" | sed 's/-.*//')
            BRANCH="rel-$ORCH_VERSION"
          fi
          echo "Using branch: $BRANCH"

          gh workflow run spec-update.yaml \
            --field file=${{ matrix.file }} \
            --field file-ref=$BRANCH \
            --field create-pr=true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: 'Slack Notification'
        if: failure()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            blocks:
              - type: 'section'
                text:
                  type: 'mrkdwn'
                  text: '‚ö†Ô∏è Weekly spec update failed! üò¨ Please inspect & fix by clicking <https://github.com/SAP/ai-sdk-js/actions/runs/${{ github.run_id }}|here>'
